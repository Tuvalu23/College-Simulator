{% extends "base.html" %}

{% block title %}Simulation Results{% endblock %}

{% block head %}
<style>
    .fade-in {
        animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Button Active State */
    .active-simulation {
        background-color: #555555; 
        cursor: not-allowed;
        opacity: 0.7;
    }

    .floating-back-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #555555;
        color: #ffffff;
        padding: 15px 25px;
        border-radius: 25px;
        text-decoration: none;
        font-size: 16px;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: background 0.3s ease, transform 0.3s ease;
    }

    .floating-back-button:hover {
        background: #333333;
        transform: scale(1.05);
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 space-y-8">

    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded shadow">
        <div class="text-lg font-semibold mb-4 md:mb-0 flex items-center space-x-4">
            <div>Current Simulation Date:</div>
            <div id="current-date" class="text-blue-600 font-bold">{{ current_date }}</div>
        </div>
        <div class="flex items-center space-x-4">
            <button id="start-button"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300 ease-in-out">
                Next Release Date
            </button>
            <button id="continue-button"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition duration-300 ease-in-out hidden">
                Continue to Next Release Date
            </button>
        </div>
    </div>

    <div class="flex flex-col md:flex-row md:space-x-8 space-y-8 md:space-y-0">

        <div class="w-full md:w-1/3 bg-white p-6 rounded shadow fade-in">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Inbox</h2>
            <p class="text-sm text-gray-500 mb-4">As the simulation date advances (jumps), your college decisions will appear here.</p>
            <div id="inbox" class="space-y-4"></div>
        </div>

        <div class="w-full md:w-2/3 bg-white p-6 rounded shadow fade-in">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Your Application Results Overview</h2>
            <p class="text-sm text-gray-500 mb-6">Your decisions will appear here once you open the status updates in the Inbox.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="overview"></div>
        </div>

    </div>

    <a href="{{ url_for('chances') }}" class="floating-back-button">
        Back
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const currentDateElem = document.getElementById('current-date');
        const startButton = document.getElementById('start-button');
        const continueButton = document.getElementById('continue-button');
        const inbox = document.getElementById('inbox');
        const overview = document.getElementById('overview');

        let simulationStarted = {{ simulation_started|default(false)|tojson }};
        let decisionsQueue = {{ decisions_queue|default([])|tojson }};
        let finalResults = {{ final_results|default({})|tojson }};
        let readEmails = {{ read_emails|default({})|tojson }};
        
        console.log("Simulation Started:", simulationStarted);
        console.log("Decisions Queue:", decisionsQueue);
        console.log("Final Results:", finalResults);
        console.log("Read Emails:", readEmails);
        
        // Sort decisions by release date
        decisionsQueue.sort((a, b) => new Date(a.release_date) - new Date(b.release_date));
        console.log("Sorted Decisions Queue:", decisionsQueue);

        let currentIndex = 0;
        let simulationDate = strToDate("{{ current_date }}");
        console.log("Initial Simulation Date:", simulationDate);

        startButton.textContent = "Next Release Date";

        function strToDate(str) {
            const [year, month, day] = str.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function dateToStr(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateCurrentDateDisplay() {
            currentDateElem.textContent = dateToStr(simulationDate);
        }

        function advanceToNextReleaseDate() {
            console.log("Advancing to next release date...");

            if (currentIndex >= decisionsQueue.length) {
                console.log("No more decisions to process.");
                startButton.classList.add('hidden');
                continueButton.classList.add('hidden');
                return;
            }

            const nextDecision = decisionsQueue[currentIndex];
            const nextReleaseDate = strToDate(nextDecision.release_date);
            console.log("Next Decision:", nextDecision);
            console.log("Next Release Date:", nextReleaseDate);

            simulationDate = nextReleaseDate;
            updateCurrentDateDisplay();
            console.log("Simulation date jumped to:", simulationDate);

            releaseEmail(nextDecision);

            startButton.classList.add('hidden');
            continueButton.classList.remove('hidden');
        }

        function continueSimulation() {
            console.log("Continuing Simulation...");
            currentIndex++;
            if (currentIndex >= decisionsQueue.length) {
                console.log("No more decisions to process.");
                continueButton.classList.add('hidden');
                return;
            }
            advanceToNextReleaseDate();
        }

        function releaseEmail(decision) {
            console.log("Releasing Email for:", decision.display_name);
            const emailDiv = document.createElement('div');
            emailDiv.classList.add('p-4', 'bg-gray-50', 'rounded', 'shadow', 'transition-transform', 'duration-300', 'hover:scale-105', 'opacity-0');

            const subject = `${decision.display_name} ${decision.app_type} Status Update`;
            emailDiv.innerHTML = `
                <div class="font-semibold text-lg">${subject}</div>
                <div class="text-sm text-gray-500">Release Date: ${decision.release_date}</div>
                <a href="/advancedsim/${decision.short_name}/login" target="_blank"
                   class="text-blue-600 underline mt-2 block hover:text-blue-800 transition-colors"
                   data-short-name="${decision.short_name}">
                   View Status Update
                </a>
            `;

            inbox.appendChild(emailDiv);
            setTimeout(() => {
                emailDiv.classList.remove('opacity-0');
            }, 100);
            console.log("Email released for:", decision.display_name);
        }

        function markAsRead(shortName) {
            console.log("Marking as read:", shortName);
            return fetch('/advancedsim/results/mark_as_read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'short_name': shortName
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Mark as read response:", data);
                if (data.status === 'success') {
                    return true;
                } else {
                    alert('Failed to mark as read.');
                    return false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while marking as read.');
                return false;
            });
        }

        function updateOverview(shortName) {
            console.log("Updating overview for:", shortName);
            if (shortName in finalResults) {
                const decision = finalResults[shortName];
                const decisionCode = decision.decision_code;
                const decisionTextMap = {
                    'A': 'Accepted',
                    'E': 'ED Acceptance',
                    'D': 'Deferred',
                    'W': 'Waitlisted',
                    'R': 'Rejected'
                };
                const decisionText = decisionTextMap[decisionCode] || decisionCode;

                let decisionColor = 'text-gray-700';
                if (decisionCode === 'A' || decisionCode === 'E') decisionColor = 'text-green-600';
                if (decisionCode === 'R') decisionColor = 'text-red-600';
                if (decisionCode === 'D') decisionColor = 'text-yellow-600';
                if (decisionCode === 'W') decisionColor = 'text-orange-600';

                const overviewDiv = document.createElement('div');
                overviewDiv.classList.add(
                    'p-6', 'bg-gray-50', 'rounded', 'shadow',
                    'transition-transform', 'duration-300', 'ease-in-out', 'transform', 'hover:scale-105', 'animate__animated', 'animate__fadeIn'
                );

                let logoPath = decision.logo_url;
                if (logoPath.startsWith('static/')) {
                    logoPath = "{{ url_for('static', filename='') }}" + logoPath.substring('static/'.length);
                }

                overviewDiv.innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${logoPath}" alt="${decision.display_name}" class="w-12 h-12 object-contain mr-4">
                        <div class="font-semibold text-xl">${decision.display_name}</div>
                    </div>
                    <div class="text-sm"><strong>Type:</strong> ${decision.app_type}</div>
                    <div class="text-sm"><strong>Decision:</strong> <span class="${decisionColor}">${decisionText}</span></div>
                `;

                overview.appendChild(overviewDiv);
                console.log("Overview updated for:", shortName);
            } else {
                console.log("No final result found for:", shortName);
            }
        }

        inbox.addEventListener('click', (event) => {
            if (event.target.tagName === 'A' && event.target.hasAttribute('data-short-name')) {
                event.preventDefault();
                const shortName = event.target.getAttribute('data-short-name');
                const href = event.target.href;

                console.log("Inbox link clicked for:", shortName);
                markAsRead(shortName).then((success) => {
                    if (success) {
                        window.open(href, '_blank');

                        const parentDiv = event.target.parentElement;
                        const displayName = parentDiv.querySelector('.font-semibold').textContent;
                        const releaseDateText = parentDiv.querySelector('.text-sm.text-gray-500').textContent.split(': ')[1];
                        parentDiv.innerHTML = `
                            <div class="font-semibold text-lg">${displayName}</div>
                            <div class="text-sm text-gray-500">Release Date: ${releaseDateText}</div>
                            <div class="text-green-600 mt-2 animate__animated animate__fadeIn">Decision Revealed</div>
                        `;

                        updateOverview(shortName);
                    }
                });
            }
        });

        startButton.addEventListener('click', () => {
            console.log("Next Release Date button clicked.");
            if (decisionsQueue.length > 0) {
                advanceToNextReleaseDate();
            } else {
                alert("No decisions to simulate. Please ensure colleges are applied.");
            }
        });

        continueButton.addEventListener('click', () => {
            console.log("Continue to Next Release Date button clicked.");
            continueSimulation();
        });

        updateCurrentDateDisplay();
    });
</script>
{% endblock %}
